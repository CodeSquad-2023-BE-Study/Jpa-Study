# 양방향 연관관계와 주의점

## 양방향 연관관계

우리는 JPA에서 연관관계를 설정할 때 방향을 고려합니다. 이 방향에는 단방향, 양방향이 존재합니다.
단방향, 양방향 연관관계는 어떤 것을 의미하는 것일까요?

데이터베이스에서 양방향이란 존재하지 않습니다. 왜냐하면 외래 키 하나로 양 쪽 테이블을 조인할 수 있기 떄문이죠.
따라서 데이터베이스는 단방향인지 양방향인지 나눌 필요가 없게 됩니다.

그런데 객체 관점에서 보면 우리는 연관관계를 맺고 있는 객체를 알고 있어야 (참조용 필드가 있어야) 다른 테이블을 참조하는 것이 가능합니다. 그렇기 때문에 두 객체 사이에 하나의 객체만 참조용 필드를 가지고 있으면 단방향, 두 객체 모두 참조용 필드를 가지고 있다면 양방향이라고 합니다.

사실 양방향 연관관계는 각각의 단방향 연관관계 두 개로 볼 수 있습니다.
비즈니스 로직에서 팀과 멤버라는 두 객체가 존재한다고 해보겠습니다.

- 팀에서 멤버를 참조가 필요
  - Team -> Member
- 멤버에서 팀으로 참조가 필요
  - Member -> Team

이렇게 두 객체에서 모두 참조가 필요하다면 단방향 연관관계 두 개, 즉 양방향 연관관계를 갖게 되는 것입니다.

### 그냥 양방향 연관관계만 쓰면 안되나?

그렇다면 그냥 무조건 양방향 연관관계를 가지면 안되나? 라고 생각할 수 있습니다.
하지만 모든 엔티티간의 관계를 양방향으로 설정하게 되면 불필요한 연관관계로 인해 애플리케이션 복잡성이 증가하고 개발자 입장에서도 두 엔티티간의 연관관계를 설정해주는 작업을 매번 수행해야 합니다.

또한 한 엔티티에서 여러 엔티티와 연관관계를 맺고 있다면 여러 연관관계를 맺고 있는 엔티티는 그 클래스의 복잡성이 증가할 수 밖에 없습니다.

그렇기 때문에 우선은 단방향으로 연관관계를 설정하고 로직상 필요한 경우에만 양방향으로 연관관계를 설정해주는 것이 좋습니다.

## 주의점

양방향 연관관계를 사용할 때 주의해야할 사항이 있습니다.
바로 연관관계의 주인에 값을 입력하지 않고 주인이 아닌 곳에 값을 입력하는 것입니다.
이게 어떤 의미인지 예제로 알아보겠습니다.

```java
public class Member {

    ...

    @ManyToOne
    public Team team;
}
```

```java
public class Team {

    ...

    @OneToMany(mappedBy = "team")
    public List<Member> members;
}
```

```java
void testSaveNonOwner() {
    // 회원 1 저장
    Member member1 = new Member("member1", "회원1");
    em.persist(member1);

    // 회원 2 저장
    Member member2 = new Member("member2", "회원2");
    em.persist(member2);

    Team team1 = new Team("team1", "팀1");

    // 주인이 아닌 곳에 연관관계 설정
    team1.getMembers().add(member1);
    team1.getMembers().add(member2);

    em.persist(team1);
}
```

예제를 보면 `회원1`, `회원2` 를 `팀1`에 저장하고 있습니다. 이후 DB의 member 테이블에 조회쿼리를 날려보면 팀 값이 null임을 확인할 수 있습니다.

이는 왜 일어나는 걸까요?
데이터베이스에서 테이블간의 관계를 생각해보면 외래 키를 가지고 있는 쪽은 연관관계의 주인, 즉 회원 테이블입니다.
회원 테이블에서 팀 테이블로 접근할 수 있는 반면, 팀 테이블에서는 회원 테이블로 접근할 수 있는 방법이 없는 것이죠.

그런데 연관관계의 주인이 아닌 쪽, 즉 팀 테이블에서 연관관계를 설정해줘도 회원 테이블에 접근할 수 있는 방법이 없기 때문에 이와 같은 현상이 발생하는 것입니다.

## 순수한 객체까지 고려

그렇다면 우리는 JPA를 사용할 때 연관 관계의 주인에만 값을 저장하면 될까요? 객체 관점에서 봤을 떄는 양쪽 방향에 모두 값을 입력해 주는 것이 가장 좋습니다.
양쪽 방향을 모두 입력하지 않으면 JPA를 사용하지 않는 순수한 객체 상태에서 문제가 발생할 수 있기 떄문입니다.

```java
void testORM_양방향() {
    // 팀1 저장
    Team team1 = new Team("team1", "팀1");
    em.persist(team1);

    Member member1 = new Member("member1", "회원1");

    // 양방향 연관관계 설정
    member1.setTeam(team1);
    team1.getMembers().add(member1);
    em.persist(member1);

    // 회원 2 저장
    Member member2 = new Member("member2", "회원2");

    member2.setTeam(team1);
    team1.getMembers().add(member2);
    em.persist(member2);
}
```
